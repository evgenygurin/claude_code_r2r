name: Codegen Checks Auto-fixer

# Automatically fix failing CI checks on Codegen-created PRs
on:
  check_suite:
    types: [completed]
  check_run:
    types: [completed]

# Permissions for Codegen to push fixes
permissions:
  contents: write
  pull-requests: write
  checks: write

jobs:
  auto-fix-checks:
    name: Auto-fix Failed Checks
    runs-on: ubuntu-latest
    
    # Only run on Codegen-created PRs with failed checks
    if: |
      github.event.check_suite.conclusion == 'failure' ||
      github.event.check_run.conclusion == 'failure'
    
    steps:
      - name: Get PR Info
        id: pr-info
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const { data: prs } = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              head: context.payload.check_suite?.head_branch || 
                    context.payload.check_run?.check_suite?.head_branch
            });
            
            const codegenPR = prs.find(pr => 
              pr.user.login.includes('codegen') ||
              pr.body?.includes('Codegen Agent')
            );
            
            if (codegenPR) {
              core.setOutput('pr_number', codegenPR.number);
              core.setOutput('is_codegen_pr', 'true');
            } else {
              core.setOutput('is_codegen_pr', 'false');
            }
      
      - name: Get Agent Run ID from PR
        if: steps.pr-info.outputs.is_codegen_pr == 'true'
        id: get-agent-run
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const prNumber = ${{ steps.pr-info.outputs.pr_number }};
            
            // Get PR details
            const { data: pr } = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: prNumber
            });
            
            // Try to extract agent run ID from PR body or comments
            const agentRunIdMatch = pr.body?.match(/Agent Run ID: `(\d+)`/);
            
            if (agentRunIdMatch) {
              core.setOutput('agent_run_id', agentRunIdMatch[1]);
              core.setOutput('has_agent_run', 'true');
            } else {
              // Try to find in comments
              const { data: comments } = await github.rest.issues.listComments({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber
              });
              
              for (const comment of comments) {
                const match = comment.body?.match(/Agent Run ID: `(\d+)`/);
                if (match) {
                  core.setOutput('agent_run_id', match[1]);
                  core.setOutput('has_agent_run', 'true');
                  return;
                }
              }
              
              core.setOutput('has_agent_run', 'false');
            }
      
      - name: Resume Agent Run for Auto-fix
        if: steps.pr-info.outputs.is_codegen_pr == 'true' && steps.get-agent-run.outputs.has_agent_run == 'true'
        env:
          CODEGEN_API_KEY: ${{ secrets.CODEGEN_API_KEY }}
          CODEGEN_ORG_ID: ${{ secrets.CODEGEN_ORG_ID }}
          AGENT_RUN_ID: ${{ steps.get-agent-run.outputs.agent_run_id }}
        run: |
          # Resume the agent run to fix failing checks
          response=$(curl -s -w "\n%{http_code}" \
            -X POST "https://api.codegen.com/v1/organizations/${CODEGEN_ORG_ID}/agent/run/${AGENT_RUN_ID}/resume" \
            -H "Authorization: Bearer ${CODEGEN_API_KEY}" \
            -H "Content-Type: application/json" \
            -d '{
              "prompt": "Fix the failing CI checks. Analyze the test failures and push a fix commit."
            }')
          
          http_code=$(echo "$response" | tail -n1)
          body=$(echo "$response" | head -n-1)
          
          if [ "$http_code" -ne 200 ]; then
            echo "::warning::Failed to resume agent run: $body"
          else
            echo "âœ… Agent run resumed for auto-fix"
          fi
          
      - name: Comment on Failed Check
        if: |
          steps.pr-info.outputs.is_codegen_pr == 'true' &&
          steps.get-agent-run.outputs.has_agent_run == 'true'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const checkName = context.payload.check_suite?.app?.name || 
                            context.payload.check_run?.name || 
                            'Unknown Check';
            
            const agentRunId = '${{ steps.get-agent-run.outputs.agent_run_id }}';
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: ${{ steps.pr-info.outputs.pr_number }},
              body: `ðŸ”§ **Codegen Auto-fixer Triggered**\n\n` +
                    `Failed check: **${checkName}**\n` +
                    `Agent Run ID: \`${agentRunId}\`\n\n` +
                    `Analyzing the failure and preparing a fix... This may take a few minutes.\n\n` +
                    `Track progress at: https://codegen.com/agents`
            });
