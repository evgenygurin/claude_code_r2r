name: Codegen Checks Auto-fixer

# Automatically fix failing CI checks on Codegen-created PRs
on:
  check_suite:
    types: [completed]
  check_run:
    types: [completed]

# Permissions for Codegen to push fixes
permissions:
  contents: write
  pull-requests: write
  checks: write

jobs:
  auto-fix-checks:
    name: Auto-fix Failed Checks
    runs-on: ubuntu-latest
    
    # Only run on Codegen-created PRs with failed checks
    if: |
      github.event.check_suite.conclusion == 'failure' ||
      github.event.check_run.conclusion == 'failure'
    
    steps:
      - name: Get PR Info
        id: pr-info
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const { data: prs } = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              head: context.payload.check_suite?.head_branch || 
                    context.payload.check_run?.check_suite?.head_branch
            });
            
            const codegenPR = prs.find(pr => 
              pr.user.login.includes('codegen') ||
              pr.body?.includes('Codegen Agent')
            );
            
            if (codegenPR) {
              core.setOutput('pr_number', codegenPR.number);
              core.setOutput('is_codegen_pr', 'true');
            } else {
              core.setOutput('is_codegen_pr', 'false');
            }
      
      - name: Trigger Codegen Auto-fix
        if: steps.pr-info.outputs.is_codegen_pr == 'true'
        uses: codegen-sh/autofix-action@v1
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          pr-number: ${{ steps.pr-info.outputs.pr_number }}
          max-retries: 3  # Default retry limit
          
      - name: Comment on Failed Check
        if: |
          steps.pr-info.outputs.is_codegen_pr == 'true' &&
          always()
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const checkName = context.payload.check_suite?.app?.name || 
                            context.payload.check_run?.name || 
                            'Unknown Check';
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: ${{ steps.pr-info.outputs.pr_number }},
              body: `ðŸ”§ Codegen is analyzing the failed check: **${checkName}**\n\nI'll push a fix shortly. This is attempt 1 of 3.`
            });
