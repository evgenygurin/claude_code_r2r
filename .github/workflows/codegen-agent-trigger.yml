name: Codegen Agent Trigger

# Trigger Codegen agents via GitHub comments and labels
on:
  issue_comment:
    types: [created]
  issues:
    types: [labeled, opened]
  pull_request:
    types: [labeled, opened]

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  trigger-agent:
    name: Trigger Codegen Agent
    runs-on: ubuntu-latest
    
    # Only run if comment mentions @codegen or has codegen label
    if: |
      (github.event_name == 'issue_comment' && 
       contains(github.event.comment.body, '@codegen')) ||
      (github.event_name == 'issues' && 
       contains(github.event.issue.labels.*.name, 'codegen')) ||
      (github.event_name == 'pull_request' && 
       contains(github.event.pull_request.labels.*.name, 'codegen'))
    
    steps:
      - name: Extract Context
        id: context
        uses: actions/github-script@v7
        with:
          script: |
            let prompt = '';
            let contextType = '';
            
            if (context.eventName === 'issue_comment') {
              prompt = context.payload.comment.body;
              contextType = context.payload.issue.pull_request ? 'pr_comment' : 'issue_comment';
            } else if (context.eventName === 'issues') {
              prompt = context.payload.issue.body;
              contextType = 'issue';
            } else if (context.eventName === 'pull_request') {
              prompt = context.payload.pull_request.body;
              contextType = 'pull_request';
            }
            
            core.setOutput('prompt', prompt);
            core.setOutput('context_type', contextType);
            
            return { prompt, contextType };
      
      - name: Call Codegen API
        env:
          CODEGEN_API_KEY: ${{ secrets.CODEGEN_API_KEY }}
          CODEGEN_ORG_ID: ${{ secrets.CODEGEN_ORG_ID }}
          PROMPT: ${{ steps.context.outputs.prompt }}
          CONTEXT_TYPE: ${{ steps.context.outputs.context_type }}
          ISSUE_NUMBER: ${{ github.event.issue.number || github.event.pull_request.number }}
          REPO_ID: ${{ github.repository_id }}
        run: |
          # Create JSON payload file to avoid escaping issues
          cat > /tmp/payload.json << 'EOFPAYLOAD'
          {
            "prompt": "$PROMPT_PLACEHOLDER",
            "repo_id": $REPO_ID_PLACEHOLDER,
            "metadata": {
              "github_context": "$CONTEXT_TYPE_PLACEHOLDER",
              "issue_number": $ISSUE_NUMBER_PLACEHOLDER,
              "triggered_by": "$TRIGGERED_BY_PLACEHOLDER"
            }
          }
          EOFPAYLOAD
          
          # Replace placeholders with actual values
          sed -i "s/\$PROMPT_PLACEHOLDER/$(echo "$PROMPT" | sed 's/[\/&]/\\&/g')/g" /tmp/payload.json
          sed -i "s/\$REPO_ID_PLACEHOLDER/${REPO_ID}/g" /tmp/payload.json
          sed -i "s/\$CONTEXT_TYPE_PLACEHOLDER/${CONTEXT_TYPE}/g" /tmp/payload.json
          sed -i "s/\$ISSUE_NUMBER_PLACEHOLDER/${ISSUE_NUMBER}/g" /tmp/payload.json
          sed -i "s/\$TRIGGERED_BY_PLACEHOLDER/${GITHUB_ACTOR}/g" /tmp/payload.json
          
          # Make API call
          response=$(curl -s -w "\n%{http_code}" \
            -X POST "https://api.codegen.com/v1/organizations/${CODEGEN_ORG_ID}/agent/run" \
            -H "Authorization: Bearer ${CODEGEN_API_KEY}" \
            -H "Content-Type: application/json" \
            -d @/tmp/payload.json)
          
          # Extract HTTP status code
          http_code=$(echo "$response" | tail -n1)
          body=$(echo "$response" | head -n-1)
          
          # Check for errors
          if [ "$http_code" -ne 200 ]; then
            echo "::error::Codegen API call failed with status $http_code"
            echo "Response: $body"
            exit 1
          fi
          
          # Save agent run ID for acknowledgment
          echo "AGENT_RUN_ID=$(echo "$body" | jq -r '.id')" >> $GITHUB_ENV
          echo "AGENT_WEB_URL=$(echo "$body" | jq -r '.web_url')" >> $GITHUB_ENV
          
          echo "âœ… Agent run created successfully (ID: $(echo "$body" | jq -r '.id'))"
      
      - name: Acknowledge Trigger
        if: env.AGENT_RUN_ID != ''
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const issueNumber = context.payload.issue?.number || 
                              context.payload.pull_request?.number;
            
            const agentRunId = process.env.AGENT_RUN_ID;
            const webUrl = process.env.AGENT_WEB_URL || 'https://codegen.com/agents';
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
              body: `ðŸ¤– **Codegen agent triggered!**\n\n` +
                    `Agent Run ID: \`${agentRunId}\`\n` +
                    `Track progress at: ${webUrl}\n\n` +
                    `The agent will start working on this shortly.`
            });
