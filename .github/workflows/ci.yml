name: CI - Tests and Quality Checks

on:
  push:
    branches: [ master, main, develop ]
  pull_request:
    branches: [ master, main, develop ]

permissions:
  contents: read
  pull-requests: write
  checks: write

jobs:
  test:
    name: Run Tests
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ["3.10", "3.11", "3.12"]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install -r requirements-dev.txt
      
      - name: Run linting (ruff)
        run: |
          ruff check . --output-format=github
      
      - name: Run type checking (mypy)
        run: |
          mypy . --no-error-summary
      
      - name: Run tests with coverage
        run: |
          pytest tests/ -v \
            --cov=mcp_server \
            --cov=sync_system \
            --cov=hooks \
            --cov-report=xml \
            --cov-report=html \
            --cov-report=term-missing \
            --cov-fail-under=80
      
      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v4
        with:
          files: ./coverage.xml
          flags: unittests
          name: codecov-${{ matrix.python-version }}
          fail_ci_if_error: false
      
      - name: Generate coverage badge
        if: matrix.python-version == '3.10'
        run: |
          pip install coverage-badge
          coverage-badge -o coverage.svg -f
      
      - name: Upload coverage badge
        if: matrix.python-version == '3.10'
        uses: actions/upload-artifact@v4
        with:
          name: coverage-badge
          path: coverage.svg

  integration-tests:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: test
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          pip install -r requirements.txt
          pip install -r requirements-dev.txt
      
      - name: Start mock R2R server
        run: |
          python tests/mocks/r2r_server.py &
          echo $! > r2r_mock.pid
          sleep 5
      
      - name: Run integration tests
        run: |
          pytest tests/integration/ -v --tb=short
      
      - name: Stop mock server
        if: always()
        run: |
          if [ -f r2r_mock.pid ]; then
            kill $(cat r2r_mock.pid) || true
          fi

  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'sarif'
          output: 'trivy-results.sarif'
      
      - name: Upload Trivy results to GitHub Security
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: 'trivy-results.sarif'
      
      - name: Run Bandit security linter
        run: |
          pip install bandit
          bandit -r mcp_server sync_system hooks -f json -o bandit-report.json
      
      - name: Upload Bandit report
        uses: actions/upload-artifact@v4
        with:
          name: bandit-report
          path: bandit-report.json

  docs-check:
    name: Documentation Check
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Check for missing docstrings
        run: |
          pip install interrogate
          interrogate -vv \
            --fail-under=80 \
            --exclude tests \
            mcp_server sync_system hooks
      
      - name: Validate markdown links
        uses: gaurav-nelson/github-action-markdown-link-check@v1
        with:
          use-quiet-mode: 'yes'
          config-file: '.github/markdown-link-check.json'
      
      - name: Check CLAUDE.md and AGENTS.md
        run: |
          if [ ! -f CLAUDE.md ]; then
            echo "Error: CLAUDE.md not found"
            exit 1
          fi
          
          if [ ! -f AGENTS.md ]; then
            echo "Error: AGENTS.md not found"
            exit 1
          fi
          
          echo "✅ Required documentation files present"

  notify-codegen:
    name: Notify Codegen on Failure
    runs-on: ubuntu-latest
    needs: [test, integration-tests, security-scan, docs-check]
    if: failure() && github.event_name == 'pull_request'
    
    steps:
      - name: Comment on PR
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const { data: pr } = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number
            });
            
            // Check if PR was created by Codegen
            if (pr.user.login.includes('codegen') || 
                pr.body?.includes('Codegen Agent')) {
              
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: `⚠️ **CI Checks Failed**\n\n` +
                      `@codegen please analyze the failures and push a fix.\n\n` +
                      `Failed jobs:\n` +
                      `- ${{ needs.test.result == 'failure' ? '❌' : '✅' }} Tests\n` +
                      `- ${{ needs.integration-tests.result == 'failure' ? '❌' : '✅' }} Integration Tests\n` +
                      `- ${{ needs.security-scan.result == 'failure' ? '❌' : '✅' }} Security Scan\n` +
                      `- ${{ needs.docs-check.result == 'failure' ? '❌' : '✅' }} Documentation Check\n\n` +
                      `View details: ${context.payload.pull_request.html_url}/checks`
              });
            }
