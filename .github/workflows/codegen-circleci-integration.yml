name: Codegen CircleCI Integration

# Monitor CircleCI checks and auto-fix failures
on:
  workflow_dispatch:
    inputs:
      circleci_build_url:
        description: 'CircleCI build URL'
        required: true
      pr_number:
        description: 'PR number to fix'
        required: true

  # Can also be triggered via webhook from CircleCI
  repository_dispatch:
    types: [circleci-failure]

permissions:
  contents: write
  pull-requests: write
  checks: write

jobs:
  circleci-monitor:
    name: Monitor CircleCI and Fix Failures
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Parse CircleCI Context
        id: parse-circleci
        run: |
          # Extract CircleCI build info from URL or webhook payload
          if [ -n "${{ github.event.inputs.circleci_build_url }}" ]; then
            BUILD_URL="${{ github.event.inputs.circleci_build_url }}"
            PR_NUMBER="${{ github.event.inputs.pr_number }}"
          else
            BUILD_URL="${{ github.event.client_payload.build_url }}"
            PR_NUMBER="${{ github.event.client_payload.pr_number }}"
          fi
          
          echo "build_url=${BUILD_URL}" >> $GITHUB_OUTPUT
          echo "pr_number=${PR_NUMBER}" >> $GITHUB_OUTPUT
      
      - name: Fetch CircleCI Logs
        id: circleci-logs
        env:
          CIRCLECI_TOKEN: ${{ secrets.CIRCLECI_TOKEN }}
        run: |
          # Parse build number from URL
          BUILD_URL="${{ steps.parse-circleci.outputs.build_url }}"
          BUILD_NUM=$(echo $BUILD_URL | grep -oP '\d+$')
          
          # Fetch logs via CircleCI API
          curl -H "Circle-Token: $CIRCLECI_TOKEN" \
            "https://circleci.com/api/v2/project/gh/${{ github.repository }}/job/${BUILD_NUM}/artifacts" \
            -o circleci-logs.json
          
          # Extract failure logs
          cat circleci-logs.json | jq -r '.items[].url' | while read url; do
            curl -H "Circle-Token: $CIRCLECI_TOKEN" "$url" >> all-logs.txt
          done
          
          # Save logs for Codegen analysis
          echo "logs<<EOF" >> $GITHUB_OUTPUT
          cat all-logs.txt >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
      
      - name: Trigger Codegen Fix
        env:
          CODEGEN_API_KEY: ${{ secrets.CODEGEN_API_KEY }}
          CODEGEN_ORG_ID: ${{ secrets.CODEGEN_ORG_ID }}
        run: |
          LOGS=$(cat all-logs.txt | jq -Rs .)
          
          curl -X POST "https://api.codegen.com/v1/organizations/${CODEGEN_ORG_ID}/agent/run" \
            -H "Authorization: Bearer ${CODEGEN_API_KEY}" \
            -H "Content-Type: application/json" \
            -d "{
              \"prompt\": \"Fix the failing CircleCI checks. Analyze the logs and push fixes to PR #${{ steps.parse-circleci.outputs.pr_number }}.\",
              \"repo_id\": ${{ github.repository_id }},
              \"metadata\": {
                \"circleci_build_url\": \"${{ steps.parse-circleci.outputs.build_url }}\",
                \"pr_number\": ${{ steps.parse-circleci.outputs.pr_number }},
                \"logs\": ${LOGS}
              }
            }"
      
      - name: Comment on PR
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: ${{ steps.parse-circleci.outputs.pr_number }},
              body: `ðŸ”§ **CircleCI Failure Detected**\n\n` +
                    `Build: ${{ steps.parse-circleci.outputs.build_url }}\n\n` +
                    `Codegen is analyzing the failure logs and will push a fix shortly.`
            });
