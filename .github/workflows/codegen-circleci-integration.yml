name: Codegen CircleCI Integration

# Monitor CircleCI checks and auto-fix failures
on:
  workflow_dispatch:
    inputs:
      circleci_build_url:
        description: 'CircleCI build URL'
        required: true
      pr_number:
        description: 'PR number to fix'
        required: true

  # Can also be triggered via webhook from CircleCI
  repository_dispatch:
    types: [circleci-failure]

permissions:
  contents: write
  pull-requests: write
  checks: write

jobs:
  circleci-monitor:
    name: Monitor CircleCI and Fix Failures
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Parse CircleCI Context
        id: parse-circleci
        run: |
          # Extract CircleCI build info from URL or webhook payload
          if [ -n "${{ github.event.inputs.circleci_build_url }}" ]; then
            BUILD_URL="${{ github.event.inputs.circleci_build_url }}"
            PR_NUMBER="${{ github.event.inputs.pr_number }}"
          else
            BUILD_URL="${{ github.event.client_payload.build_url }}"
            PR_NUMBER="${{ github.event.client_payload.pr_number }}"
          fi
          
          echo "build_url=${BUILD_URL}" >> $GITHUB_OUTPUT
          echo "pr_number=${PR_NUMBER}" >> $GITHUB_OUTPUT
      
      - name: Fetch CircleCI Logs
        id: circleci-logs
        env:
          CIRCLECI_TOKEN: ${{ secrets.CIRCLECI_TOKEN }}
        run: |
          # Parse build number from URL
          BUILD_URL="${{ steps.parse-circleci.outputs.build_url }}"
          BUILD_NUM=$(echo $BUILD_URL | grep -oP '\d+$')
          
          # Fetch logs via CircleCI API
          curl -H "Circle-Token: $CIRCLECI_TOKEN" \
            "https://circleci.com/api/v2/project/gh/${{ github.repository }}/job/${BUILD_NUM}/artifacts" \
            -o circleci-logs.json
          
          # Extract failure logs
          cat circleci-logs.json | jq -r '.items[].url' | while read url; do
            curl -H "Circle-Token: $CIRCLECI_TOKEN" "$url" >> all-logs.txt
          done
          
          # Save logs for Codegen analysis
          echo "logs<<EOF" >> $GITHUB_OUTPUT
          cat all-logs.txt >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
      
      - name: Trigger Codegen Fix
        env:
          CODEGEN_API_KEY: ${{ secrets.CODEGEN_API_KEY }}
          CODEGEN_ORG_ID: ${{ secrets.CODEGEN_ORG_ID }}
          PR_NUMBER: ${{ steps.parse-circleci.outputs.pr_number }}
          BUILD_URL: ${{ steps.parse-circleci.outputs.build_url }}
        run: |
          # Create payload with logs
          logs_content=$(cat all-logs.txt | head -c 10000)  # Limit to 10KB
          
          cat > /tmp/circleci_payload.json << 'EOFPAYLOAD'
          {
            "prompt": "Fix the failing CircleCI checks for PR #PR_NUM. Analyze the build logs and push fixes.\n\nCircleCI Build: BUILD_URL_PLACEHOLDER\n\nLogs excerpt:\nLOGS_PLACEHOLDER",
            "repo_id": REPO_ID_PLACEHOLDER,
            "metadata": {
              "circleci_build_url": "BUILD_URL_PLACEHOLDER",
              "pr_number": PR_NUM,
              "source": "circleci_integration"
            }
          }
          EOFPAYLOAD
          
          # Replace placeholders
          sed -i "s|REPO_ID_PLACEHOLDER|${{ github.repository_id }}|g" /tmp/circleci_payload.json
          sed -i "s|PR_NUM|${PR_NUMBER}|g" /tmp/circleci_payload.json
          sed -i "s|BUILD_URL_PLACEHOLDER|${BUILD_URL}|g" /tmp/circleci_payload.json
          sed -i "s|LOGS_PLACEHOLDER|$(echo "$logs_content" | head -n 50 | sed 's/[\/&]/\\&/g')|g" /tmp/circleci_payload.json
          
          # Make API call
          response=$(curl -s -w "\n%{http_code}" \
            -X POST "https://api.codegen.com/v1/organizations/${CODEGEN_ORG_ID}/agent/run" \
            -H "Authorization: Bearer ${CODEGEN_API_KEY}" \
            -H "Content-Type: application/json" \
            -d @/tmp/circleci_payload.json)
          
          http_code=$(echo "$response" | tail -n1)
          body=$(echo "$response" | head -n-1)
          
          if [ "$http_code" -ne 200 ]; then
            echo "::error::Failed to trigger Codegen fix: $body"
            exit 1
          fi
          
          echo "AGENT_RUN_ID=$(echo "$body" | jq -r '.id')" >> $GITHUB_ENV
          echo "âœ… Codegen fix triggered"
      
      - name: Comment on PR
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: ${{ steps.parse-circleci.outputs.pr_number }},
              body: `ðŸ”§ **CircleCI Failure Detected**\n\n` +
                    `Build: ${{ steps.parse-circleci.outputs.build_url }}\n\n` +
                    `Codegen is analyzing the failure logs and will push a fix shortly.`
            });
