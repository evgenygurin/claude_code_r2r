# Анализ возможностей R2R API

> **Этап 1**: Изучение возможностей R2R с критическим мышлением
>
> **Дата**: 2025-11-19
>
> **Цель**: Понять, что R2R может предложить для интеграции с Claude Code

---

## Оглавление

1. [Общее описание R2R](#общее-описание-r2r)
2. [Ключевые возможности](#ключевые-возможности)
3. [API Endpoints](#api-endpoints)
4. [Асинхронность и фоновая работа](#асинхронность-и-фоновая-работа)
5. [Критический анализ](#критический-анализ)
6. [Выводы для интеграции](#выводы-для-интеграции)

---

## Общее описание R2R

**R2R (Retrieval to Riches)** - это движок для построения пользовательских RAG (Retrieval-Augmented Generation) приложений.

### Архитектура
- RESTful API (v3)
- Поддержка векторного поиска (pgvector)
- Knowledge Graph
- Асинхронная обработка задач через Hatchet
- Docker-based deployment

### Адрес инстанса
```
http://136.119.36.216:7272
```

---

## Ключевые возможности

### 1. Управление документами (Documents API)

#### 1.1 Загрузка и обработка документов

**Endpoints:**
- `POST /v3/documents` - Создание нового документа
- `POST /v3/documents/{id}` - Обновление существующего документа
- `DELETE /v3/documents/{id}` - Удаление документа
- `DELETE /v3/documents/by-filter` - Массовое удаление по фильтрам

**Возможности:**
- Загрузка файлов (PDF, текст, аудио, изображения)
- Загрузка текстового контента напрямую
- Загрузка предобработанных чанков
- Автоматическое chunking
- Автоматическая генерация summary
- Извлечение метаданных

**Режимы ingestion:**
- `hi-res` - полная обработка с enrichment
- `fast` - быстрая загрузка без enrichment
- `custom` - кастомная конфигурация

**Критический вопрос:** Как долго занимает обработка? Можем ли мы отслеживать прогресс?
**Ответ:** Да, процесс асинхронный, возвращает `task_id` для отслеживания.

#### 1.2 Получение информации о документах

**Endpoints:**
- `GET /v3/documents` - Список документов с пагинацией
- `GET /v3/documents/{id}` - Детали конкретного документа
- `GET /v3/documents/{id}/chunks` - Получение чанков документа
- `GET /v3/documents/{id}/download` - Скачивание оригинального файла

**Возможности:**
- Фильтрация по ID
- Пагинация (offset, limit)
- Получение embeddings summary
- Статусы ingestion и extraction
- Метаданные: title, size, type, версия, дата создания/обновления

**Критический вопрос:** Можем ли мы получать только изменённые документы?
**Ответ:** Есть поля `created_at` и `updated_at`, можно фильтровать по ним.

#### 1.3 Knowledge Graph Extraction

**Endpoints:**
- `POST /v3/documents/{id}/extract` - Извлечение entities и relationships
- `GET /v3/documents/{id}/entities` - Получение entities
- `GET /v3/documents/{id}/relationships` - Получение relationships

**Возможности:**
- Настройка типов entities
- Настройка типов relationships
- Merge count для объединения экстракций
- Лимит на количество relationships
- Кастомизация generation config

**Критический вопрос:** Может ли это работать в фоне?
**Ответ:** Да, параметр `run_with_orchestration=true` (по умолчанию).

---

### 2. Conversations API

#### 2.1 Управление диалогами

**Endpoints:**
- `POST /v3/conversations` - Создание нового диалога
- `GET /v3/conversations` - Список диалогов
- `GET /v3/conversations/{id}` - Детали диалога
- `DELETE /v3/conversations/{id}` - Удаление диалога

**Возможности:**
- Автоматическое создание для текущего пользователя
- Пагинация и фильтрация
- Metadata для диалогов
- Timestamps (created_at)

**Критический вопрос:** Как связать диалог с конкретным проектом в Claude Code?
**Размышление:** Можно использовать user_id или metadata с project_id.

#### 2.2 Управление сообщениями

**Endpoints:**
- `POST /v3/conversations/{id}/messages` - Добавление сообщения
- `PUT /v3/conversations/{id}/messages/{message_id}` - Обновление сообщения

**Возможности:**
- Поддержка ролей (user, assistant)
- Вложенность через parent_id
- Metadata для сообщений
- Function calls и tool calls

**Критический вопрос:** Как это работает с ветвлением?
**Ответ:** Поддержка branching через parent_id и branches endpoint.

#### 2.3 Ветвление (Branching)

**Endpoints:**
- `GET /v3/conversations/{id}/branches` - Список веток

**Возможности:**
- Создание альтернативных путей диалога
- branch_point_id для указания точки ветвления
- Пагинация веток

**Критический вопрос:** А что если Claude создаёт несколько попыток ответа - можем ли мы это сохранить как branches?
**Потенциал:** Да, это отличный use case для веток!

---

### 3. Retrieval API

#### 3.1 Search

**Endpoint:** `POST /v3/retrieval/search`

**Режимы поиска:**
- `basic` - преимущественно semantic search
- `advanced` - hybrid search (semantic + full-text)
- `custom` - полный контроль над настройками

**Типы поиска:**
- **Vector Search** - семантический поиск по embeddings
- **Full-text Search** - поиск по ключевым словам (PostgreSQL ts_rank_cd)
- **Hybrid Search** - комбинация с Reciprocal Rank Fusion (RRF)
- **Knowledge Graph Search** - поиск по entities и relationships

**Фильтрация:**
Поддержка операторов: `$eq`, `$neq`, `$gt`, `$gte`, `$lt`, `$lte`, `$like`, `$ilike`, `$in`, `$nin`

**Критический вопрос:** Какая производительность при больших объёмах?
**Размышление:** Зависит от индексации PostgreSQL и настроек pgvector.

#### 3.2 RAG Generation

**Endpoint:** `POST /v3/retrieval/rag`

**Возможности:**
- Комбинация search + generation
- Настройка generation config (model, temperature, max_tokens)
- Фильтрация как в search
- Source attribution

**Возвращаемые данные:**
- chunk_search_results
- graph_search_results
- generated_answer

**Критический вопрос:** Можем ли мы кастомизировать промпт для генерации?
**Размышление:** Возможно через generation_config, но нужна детальная документация.

#### 3.3 Conversational Agent

**Endpoint:** `POST /v3/retrieval/agent`

**Возможности:**
- Multi-turn диалоги с RAG
- Управление через conversation_id и branch_id
- Streaming поддержка
- Source citations
- Контекстная память

**Use Cases:**
- Research assistance
- Document analysis
- Technical support
- Q&A systems
- Knowledge base exploration

**Критический вопрос:** Как это соотносится с субагентами Claude Code?
**Потенциал:** Может быть использован как специализированный RAG-субагент!

#### 3.4 Completion

**Endpoint:** `POST /v3/retrieval/completion`

**Возможности:**
- Прямая генерация без retrieval
- Кастомизация generation config
- Single-turn и multi-turn

**Критический вопрос:** Зачем это нужно в R2R?
**Размышление:** Для flexibility - иногда нужна просто генерация без поиска.

#### 3.5 Embeddings

**Endpoint:** `POST /v3/retrieval/embedding`

**Возможности:**
- Генерация векторных представлений текста
- Указание модели

**Критический вопрос:** Можем ли мы использовать это для кастомных embeddings?
**Потенциал:** Да, для семантического сравнения кода, документации и т.д.

---

## Асинхронность и фоновая работа

### Orchestration через Hatchet

**Асинхронные операции:**
- Document ingestion (chunking, summarization)
- Entity & relationship extraction
- Knowledge graph building
- Индексация

**Параметр:** `run_with_orchestration` (boolean)
- `true` - выполнение в фоне через Hatchet
- `false` - синхронное выполнение

**Tracking:**
- Возврат `task_id`
- Статусы: `pending`, `success`, `failed`
- Поля: `ingestion_status`, `extraction_status`

**Критический вопрос:** Как мониторить статус задачи?
**Ответ:** Периодический polling через GET /v3/documents/{id} для проверки статусов.

**Критический вопрос:** Что если Claude Code перезапустится?
**Размышление:** Task продолжит работать на стороне R2R, можно проверить статус при старте.

---

## Критический анализ

### Что работает хорошо?

1. **Асинхронность** - отличная поддержка фоновой работы
2. **Flexibility** - множество режимов поиска и конфигураций
3. **RAG Agent** - готовый conversational агент с контекстом
4. **Knowledge Graph** - расширенные возможности для связанных данных
5. **Conversations** - встроенная поддержка диалогов с ветвлением
6. **Фильтрация** - мощные возможности фильтрации

### А что если...?

#### А что если документация изменилась?
- Можно обновить через `POST /v3/documents/{id}`
- Отслеживать `updated_at`
- Настроить автоматическую переиндексацию

#### А что если проект большой?
- Collections для организации документов
- Фильтрация по collection_ids
- Пагинация везде

#### А что если нужна кастомная обработка?
- Custom ingestion_config
- Custom generation_config
- Custom search settings

#### А вдруг это медленно?
- Асинхронная обработка решает проблему
- Можно настроить индексы PostgreSQL
- Hybrid search с настройкой весов

#### А что если нужно удалить старые документы?
- Поддержка bulk delete by filter
- Можно автоматизировать очистку

---

## Выводы для интеграции

### Сильные стороны для Claude Code

1. **Асинхронная обработка** ✅
   - Загрузка документации в фоне
   - Не блокирует работу Claude Code

2. **Conversations API** ✅
   - Идеально для хранения диалогов Claude Code
   - Branching для альтернативных путей
   - Связь с пользователями

3. **RAG Agent** ✅
   - Готовый агент для работы с документацией
   - Можно интегрировать как субагент

4. **Search & Retrieval** ✅
   - Множество режимов поиска
   - Отлично для поиска в документации

5. **Knowledge Graph** ✅
   - Для связывания концепций в коде
   - Entities = функции, классы, модули
   - Relationships = вызовы, наследование, зависимости

### Слабые стороны / Вопросы

1. **Мониторинг задач** ⚠️
   - Нет endpoint для прямого мониторинга task_id
   - Только polling через document status

2. **Webhooks** ❓
   - Нет упоминаний о webhooks для уведомлений
   - Нужно проверить в полной документации

3. **Streaming** ⚠️
   - Упоминается, но детали не ясны
   - Как это работает с HTTP?

4. **Аутентификация** ❓
   - Как настроен доступ к конкретному инстансу?
   - API keys? OAuth?

---

## Следующие шаги

1. ✅ Изучить возможности R2R API
2. ⏭️ Изучить возможности Claude Code
3. ⏭️ Сопоставить требования и возможности
4. ⏭️ Описать архитектуру интеграции
5. ⏭️ Создать детальную документацию с примерами

---

## Метаданные

- **Версия документа**: 1.0
- **Статус**: Завершён этап 1
- **Следующий шаг**: Анализ возможностей Claude Code
- **Критические вопросы**: 12 вопросов задано и проанализировано
- **Потенциальные проблемы**: 4 выявлено
